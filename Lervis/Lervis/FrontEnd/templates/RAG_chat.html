<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>RAG Chat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    marked.setOptions({ breaks: true });
  </script>
</head>
<body>
  <div id="top-bar">
    <button id="reset-button">‚ö° Nueva conversaci√≥n ‚ö°</button>
  </div>
  <div id="chat-container">
    <div id="chat-box"></div>
    <div id="input-area">
      <textarea id="user-input" placeholder="Escribe aqu√≠..."></textarea>
      <button id="send-button">Enviar</button>
    </div>
  </div>

  <script>
    window.onload = () => {
      // referencias a los elementos del DOM
      const resetBtn = document.getElementById("reset-button");
      const input = document.getElementById("user-input");
      const chatBox = document.getElementById("chat-box");
      const sendButton = document.getElementById("send-button");

      resetBtn.addEventListener("click", async () => {
        console.log("üîµ Bot√≥n de reset pulsado");
        const res = await fetch("/reset", { method: "POST" });
        if (res.ok) {
          console.log("üü¢ Sesi√≥n reseteada correctamente");
          chatBox.innerHTML = "";
          input.value = "";
        }
      });

      async function readStream(reader, decoder, content, chatBox) {
        console.log("üü† Empezando a leer el stream...");
        let chunkTotal = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            console.log("üü¢ Stream terminado");
            break;
          }

          let chunk = decoder.decode(value, { stream: true });
          //console.log("üß© Chunk recibido:", chunk);
          chunkTotal += chunk;
          content.textContent = chunkTotal;
          chatBox.scrollTop = chatBox.scrollHeight;
        }

        console.log("üü° Texto final acumulado del stream:", chunkTotal);
        return chunkTotal;
      }

      async function sendMessage() {
        const message = input.value.trim();
        if (!message) {
          console.log("‚ö™ Input vac√≠o, no se env√≠a nada");
          return;
        }

        console.log("üîµ Enviando mensaje:", message);

        const userMsg = document.createElement("div");
        userMsg.className = "message user";
        userMsg.textContent = message;
        chatBox.appendChild(userMsg);
        input.value = "";

        const botMsg = document.createElement("div");
        botMsg.className = "message bot";
        const content = document.createElement("div");
        botMsg.appendChild(content);
        chatBox.appendChild(botMsg);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
          console.log("üü† Haciendo fetch a /chat...");
          const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message })
          });

          console.log("üü¢ Conexi√≥n establecida con /chat, empezando stream");
          const reader = res.body.getReader();
          const decoder = new TextDecoder();

          const chunkTotal = await readStream(reader, decoder, content, chatBox);

          if (chunkTotal.trim() !== "") {
            console.log("üü¢ Texto recibido, enviando a /save_context...");
            await fetch("/save_context", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ mensaje_usuario: message,
                                    respuesta_lervis: chunkTotal })
            });
            console.log("‚úÖ Guardado exitoso en /save_context");
          } else {
            console.warn("‚ö†Ô∏è No hay texto acumulado para enviar a /save_context");
          }

          const formatted = chunkTotal
            .replace(/\r?\n\r?\n/g, '\n\n')
            .replace(/([^\n])\n(?=[^\n])/g, '$1  \n');
          const markdownFormatted = marked.parse(formatted);
          content.innerHTML = markdownFormatted;

          console.log("‚úÖ Respuesta formateada y renderizada");

        } catch (error) {
          console.error("‚ùå Error en sendMessage:", error);
          content.innerText = error;
        }
      }

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      sendButton.addEventListener("click", sendMessage);
    };
  </script>
</body>
</html>
